# Phase 3 E2E 테스트 가이드

## 준비사항

### 1. Python 서버 실행 ✅
```bash
cd /Users/kbsoo/Codes/projects/soccerHUD
source .venv/bin/activate
python src/main.py
```

**확인사항:**
- 서버가 `http://localhost:8765`에서 실행 중
- 로그에 "서버 준비 완료!" 메시지 표시
- DeepSORT 및 PlayerMatcher 초기화 완료

---

## 테스트 절차

### 단계 1: 크롬 익스텐션 로드

1. **Chrome 열기** (개발자 모드)
   - 주소창에 `chrome://extensions/` 입력

2. **개발자 모드 활성화**
   - 우측 상단 "개발자 모드" 토글 ON

3. **압축해제된 확장 프로그램 로드**
   - "압축해제된 확장 프로그램을 로드합니다" 클릭
   - 폴더 선택: `/Users/kbsoo/Codes/projects/soccerHUD/extension`

4. **익스텐션 확인**
   - SoccerHUD 아이콘이 나타남
   - 에러 없이 로드되어야 함

---

### 단계 2: YouTube 영상 재생

1. **테스트 영상 열기**
   - URL: https://www.youtube.com/watch?v=tKg81nVeoUI
   - (대한민국 vs 파라과이 경기)

2. **영상 재생**
   - 1분 30초 ~ 2분 구간으로 이동
   - 재생 시작

3. **Console 확인** (F12 → Console 탭)
   - "🎯 SoccerHUD Content Script 로드됨" 메시지 확인
   - "✅ 비디오 요소 발견" 메시지 확인
   - "✅ 오버레이 컨테이너 생성됨" 메시지 확인

---

### 단계 3: 명단 입력 테스트

1. **SoccerHUD 팝업 열기**
   - Chrome 우측 상단 SoccerHUD 아이콘 클릭

2. **"명단" 탭으로 이동**
   - 탭 전환 확인

3. **홈팀 명단 입력** (빨강팀 = 대한민국)
   ```
   등번호: 7
   이름: 손흥민
   포지션: FW
   → "선수 추가" 클릭

   등번호: 3
   이름: 김민재
   포지션: CB
   → "선수 추가" 클릭

   등번호: 18
   이름: 이강인
   포지션: MF
   → "선수 추가" 클릭
   ```

4. **원정팀 명단 입력** (파랑팀 = 파라과이)
   ```
   등번호: 9
   이름: 로메로
   포지션: FW
   → "선수 추가" 클릭

   등번호: 4
   이름: 발부에나
   포지션: DF
   → "선수 추가" 클릭
   ```

5. **명단 저장**
   - "명단 저장" 버튼 클릭
   - 성공 메시지 확인: "명단 저장 성공! 홈: 3명, 원정: 2명"

**예상 결과:**
- ✅ 입력한 선수가 리스트에 표시됨
- ✅ 서버 로그에 "명단 설정: 홈 3명, 원정 2명" 메시지 출력

---

### 단계 4: 탐지 활성화

1. **"컨트롤" 탭으로 이동**

2. **활성화 버튼 클릭**
   - "활성화" → "비활성화"로 변경
   - 서버 상태: "✅ 연결됨"

3. **WebSocket 연결 확인**
   - Console에 "🔌 WebSocket 연결됨" 메시지
   - 서버 로그에 "WebSocket 클라이언트 연결됨" 메시지

**예상 결과:**
- ✅ 영상 위에 바운딩 박스가 나타남
- ✅ 선수마다 `[Track ID] TEAM` 라벨이 표시됨

---

### 단계 5: 추적 ID 일관성 확인

**목표:** 동일 선수가 프레임 간 같은 Track ID를 유지하는지 확인

1. **특정 선수 선택**
   - 화면 중앙의 선수 하나 선택
   - Track ID 기억 (예: `[3] HOME`)

2. **5~10초간 관찰**
   - 선수가 움직여도 Track ID 유지되는지 확인
   - 다른 선수와 겹쳐도 ID가 바뀌지 않는지 확인

3. **카메라 전환 테스트**
   - 영상을 다른 시점으로 이동 (예: 3분 구간)
   - 카메라가 바뀌면 Track ID가 리셋되어야 함
   - 서버 로그에 "카메라 전환 감지 - 트랙 리셋" 메시지

**예상 결과:**
- ✅ 같은 카메라 시점에서는 ID 일관성 유지
- ✅ 카메라 전환 시 자동 리셋

---

### 단계 6: 수동 매칭 테스트

**목표:** Track ID를 실제 선수에 매칭하여 이름 표시

1. **Track ID 확인**
   - 화면에서 빨강팀 선수의 Track ID 확인 (예: `[5] HOME`)

2. **API로 매칭** (Terminal)
   ```bash
   curl -X POST http://localhost:8765/api/match \
     -H "Content-Type: application/json" \
     -d '{
       "track_id": 5,
       "team": "home",
       "number": 7
     }'
   ```

3. **오버레이 확인**
   - Track ID 5번 선수의 라벨이 `[5] 손흥민 #7`로 변경되어야 함

4. **다른 선수도 매칭**
   ```bash
   # Track ID 3을 김민재로 매칭
   curl -X POST http://localhost:8765/api/match \
     -H "Content-Type: application/json" \
     -d '{
       "track_id": 3,
       "team": "home",
       "number": 3
     }'
   ```

**예상 결과:**
- ✅ 매칭된 선수는 `[Track ID] 이름 #번호` 형식으로 표시
- ✅ 매칭 안 된 선수는 `[Track ID] TEAM` 형식 유지

---

### 단계 7: 공 소유자 확인

1. **공이 보이는 장면으로 이동**

2. **오버레이 확인**
   - 공이 초록색 원으로 표시되는지 확인
   - 공 근처 선수의 바운딩 박스 색상이 더 진해지는지 확인

3. **Console 로그 확인**
   - `ball_owner` 필드에 `player_id`, `distance`, `confidence` 값 출력

**예상 결과:**
- ✅ 공이 탐지되면 초록색 원 표시
- ✅ 가장 가까운 선수가 강조됨

---

## 체크리스트

### 기능 확인
- [ ] Python 서버 정상 실행
- [ ] 크롬 익스텐션 로드 성공
- [ ] YouTube 비디오 감지
- [ ] WebSocket 연결 성공
- [ ] 선수 바운딩 박스 표시
- [ ] Track ID 표시
- [ ] 명단 입력 UI 작동
- [ ] 명단 저장 성공
- [ ] Track ID 일관성 유지
- [ ] 카메라 전환 시 자동 리셋
- [ ] 수동 매칭 후 이름 표시
- [ ] 공 탐지 및 표시
- [ ] 공 소유자 강조

### 성능 확인
- [ ] FPS: 5 FPS 이상 유지
- [ ] WebSocket 지연: 100ms 이하
- [ ] 서버 응답 시간: 200ms 이하

---

## 문제 해결

### 서버 연결 안 됨
**증상:** 팝업에서 "서버 연결 안 됨"
**해결:**
1. Python 서버가 실행 중인지 확인
2. `http://localhost:8765/health` 접속해서 서버 응답 확인
3. CORS 설정 확인 (console에 CORS 에러 없는지)

### 비디오를 찾지 못함
**증상:** Console에 "비디오를 찾지 못함" 반복
**해결:**
1. YouTube 페이지 새로고침
2. 영상이 완전히 로드된 후 익스텐션 활성화
3. F12 → Elements에서 `video.html5-main-video` 요소 있는지 확인

### Track ID가 계속 바뀜
**증상:** 같은 선수의 ID가 프레임마다 변경
**해결:**
1. DeepSORT `n_init=3` 설정 확인 (초기 3프레임은 tentative 상태)
2. 서버 로그에서 "카메라 전환 감지" 메시지 확인
3. 영상 화질이 너무 낮으면 ReID 실패 가능

### 이름이 표시 안 됨
**증상:** 매칭했는데도 `[Track ID] TEAM`만 표시
**해결:**
1. 명단이 서버에 저장되었는지 확인:
   ```bash
   curl http://localhost:8765/api/roster
   ```
2. Track ID와 등번호가 정확히 매칭되었는지 확인
3. Content script가 최신 버전인지 확인 (extension 폴더 다시 로드)

### 공이 탐지 안 됨
**증상:** 공이 있는데 표시 안 됨
**해결:**
1. 이것은 알려진 이슈 (Phase 2 참고)
2. BALL_CONFIDENCE_THRESHOLD=0.3으로 낮췄지만 여전히 낮은 탐지율
3. Phase 5에서 파인튜닝으로 해결 예정

---

## 다음 단계

E2E 테스트가 모두 통과하면:

1. **Phase 4로 진행**: 통계 시스템 (소유 시간, 터치 횟수)
2. **Phase 5로 진행**: YOLO 파인튜닝 (공 탐지율 개선)
3. **UI 개선**: 더 나은 오버레이 디자인
4. **자동 매칭**: OCR로 등번호 자동 인식

---

## 스크린샷 예시

**성공적인 테스트 화면:**
```
[3] 김민재 #3          (빨강 바운딩 박스)
[5] 손흥민 #7          (빨강 바운딩 박스)
[7] HOME               (빨강 바운딩 박스, 매칭 안 됨)
[2] AWAY               (파랑 바운딩 박스)
     ⚽ BALL            (초록색 원)
```

---

**테스트 완료 후 이 가이드에 결과를 기록해주세요!**
